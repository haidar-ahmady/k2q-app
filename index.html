<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Scan Aset BMN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
      import {
        getFirestore,
        doc,
        getDoc,
        collection,
        addDoc,
        Timestamp
      } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
      import { firebaseConfig } from "./firebase-config.js";

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      window.loadDetailAset = async function (id) {
        const resultDiv = document.getElementById("qr-result");
        const formContainer = document.getElementById("formContainer");
        resultDiv.innerHTML = "";
        formContainer.innerHTML = "";

        const docRef = doc(db, "aset", id);
        const docSnap = await getDoc(docRef);

        if (!docSnap.exists()) {
          resultDiv.innerHTML = `<div class="alert alert-danger">Aset dengan ID <strong>${id}</strong> tidak ditemukan.</div>`;
          return;
        }

        const data = docSnap.data();

        // Format waktu sekarang untuk input datetime-local
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const localNow = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;

        resultDiv.innerHTML = `
          <div class="card mt-4 text-start">
            <div class="card-body">
              <h5>Detail Aset</h5>
              <p><strong>ID:</strong> ${id}</p>
              <p><strong>Aset:</strong> ${data.nama || "-"}</p>
              <p><strong>Merek:</strong> ${data.merek || "-"}</p>
              <p><strong>NUP:</strong> ${data.nup || "-"}</p>
              <p><strong>Lokasi:</strong> ${data.lokasi || "-"}</p>
            </div>
          </div>
        `;

        formContainer.innerHTML = `
          <div class="card mt-3 text-start">
            <div class="card-body">
              <h5>Ajukan Perbaikan</h5>
              <form id="formAjukan">
                <div class="mb-3">
                  <label for="namaPengaju" class="form-label">Nama yang Mengajukan</label>
                  <input type="text" class="form-control" id="namaPengaju" required />
                </div>
                <div class="mb-3">
                  <label for="tanggalPengajuan" class="form-label">Tanggal Pengajuan</label>
                  <input type="datetime-local" class="form-control" id="tanggalPengajuan" value="${localNow}" required />
                </div>
                <div class="mb-3">
                  <label for="uraian" class="form-label">Uraian</label>
                  <textarea class="form-control" id="uraian" rows="3" required></textarea>
                </div>
                <button type="submit" class="btn btn-success">Ajukan</button>
              </form>
            </div>
          </div>
        `;

        document.getElementById("formAjukan").addEventListener("submit", async (e) => {
          e.preventDefault();
          const namaPengaju = document.getElementById("namaPengaju").value.trim();
          const uraian = document.getElementById("uraian").value.trim();
          const tanggalInput = document.getElementById("tanggalPengajuan").value;

          if (!namaPengaju || !uraian || !tanggalInput) return;

          const tanggal = Timestamp.fromDate(new Date(tanggalInput));

          await addDoc(collection(db, "pengajuan_perbaikan"), {
            id,
            nama: namaPengaju,
            uraian,
            tanggal,
            status: "diajukan",
          });

          alert("Pengajuan berhasil dikirim!");
          document.getElementById("formAjukan").reset();
        });
      };
    </script>
  </head>
  <body class="bg-light">
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4>Scan QR Aset BMN</h4>
        <a href="admin-login.html" class="btn btn-outline-secondary">Masuk sebagai Admin</a>
      </div>

      <div class="text-center mb-4">
        <div id="qr-reader" style="width: 300px; margin: auto;"></div>
      </div>

      <div id="qr-result"></div>
      <div id="formContainer"></div>
    </div>

    <script>
      function onScanSuccess(decodedText) {
        loadDetailAset(decodedText);
      }

      function onScanFailure(error) {
        // Tidak ditampilkan agar tidak mengganggu pengguna
      }

      const scanner = new Html5QrcodeScanner("qr-reader", {
        fps: 10,
        qrbox: 250,
      }, false);

      scanner.render(onScanSuccess, onScanFailure);
    </script>
  </body>
</html>
