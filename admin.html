<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Admin BMN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-3">
      <a class="navbar-brand" href="#">Admin BMN</a>
      <div class="ms-auto">
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </nav>

    <div class="container mt-4">
      <h3 class="mb-3">Dashboard Admin - Daftar Aset</h3>

      <div class="row mb-3 align-items-end">
        <div class="col-md-6">
          <input
            type="text"
            id="searchInput"
            class="form-control"
            placeholder="Cari ID Aset..."
          />
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="loadAset()">Cari</button>
        </div>
        <div class="col-md-2">
          <button id="scanBtn" class="btn btn-outline-secondary w-100" onclick="toggleScan()">
  Scan QR
</button>

        </div>
      </div>

      <div id="qr-reader" style="width: 300px; margin-bottom: 20px;"></div>

      <div id="asetList" class="row gy-4"></div>

      <hr />

      <div id="riwayatPengajuan" class="mt-4"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        query,
        where,
        orderBy,
        doc,
        getDoc
      } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";
      import { firebaseConfig } from "./firebase-config.js";

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Validasi login admin
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          alert("Anda harus login sebagai admin.");
          window.location.href = "admin-login.html";
        } else {
          const userDoc = await getDoc(doc(db, "user", user.uid));
          if (!userDoc.exists() || userDoc.data().role !== "admin") {
            alert("Anda tidak memiliki akses admin.");
            window.location.href = "index.html";
          }
        }
      });

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        signOut(auth).then(() => {
          window.location.href = "index.html";
        }).catch((error) => {
          console.error("Logout gagal:", error);
        });
      });

      // Load aset
      async function loadAset() {
        const asetList = document.getElementById("asetList");
        const search = document.getElementById("searchInput").value.trim().toLowerCase();
        const snapshot = await getDocs(collection(db, "aset"));
        asetList.innerHTML = "";

        snapshot.forEach((doc) => {
          const data = doc.data();
          const id = doc.id;
          const nama = data.nama || "-";
          const merek = data.merek || "-";
          const lokasi = data.lokasi || "-";
          const nup = data.nup || "-";

          if (search && id.toLowerCase() !== search) return;

          const div = document.createElement("div");
          div.className = "col-12";
          div.innerHTML = `
            <div class="card">
              <div class="card-body">
                <h5>ID: ${id}</h5>
                <p>Aset: ${nama}</p>
                <p>Merek: ${merek}</p>
                <p>Lokasi: ${lokasi}</p>
                <p>NUP: ${nup}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="window.location.href='riwayat.html?id=' + encodeURIComponent('${id}')">

                  Lihat Riwayat Pengajuan
                </button>
              </div>
            </div>
          `;
          asetList.appendChild(div);
        });

        if (asetList.innerHTML === "") {
          asetList.innerHTML = "<p class='text-muted'>Tidak ada aset ditemukan.</p>";
        }

        document.getElementById("riwayatPengajuan").innerHTML = "";
      }

      // Inisialisasi scanner
      
        let qrReader = null;
let isScanning = false;

window.toggleScan = function () {
  const qrContainer = document.getElementById("qr-reader");

  if (isScanning) {
    // Hentikan dan hilangkan scanner
    qrReader.stop().then(() => {
      qrContainer.innerHTML = "";
      isScanning = false;
      document.getElementById("scanBtn").innerText = "Scan QR";
    }).catch((err) => {
      console.error("Gagal menghentikan scanner:", err);
    });
  } else {
    // Tampilkan scanner
    qrReader = new Html5Qrcode("qr-reader");
    qrReader.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        qrReader.stop().then(() => {
          qrContainer.innerHTML = "";
          isScanning = false;
          document.getElementById("scanBtn").innerText = "Scan QR";

          document.getElementById("searchInput").value = decodedText;
          loadAset();
        });
      },
      (errorMessage) => {
        // Optional: console.warn("Scan error:", errorMessage);
      }
    ).then(() => {
      isScanning = true;
      document.getElementById("scanBtn").innerText = "Matikan QR";
    }).catch((err) => {
      console.error("Gagal memulai scanner:", err);
    });
  }
};

      

      window.loadAset = loadAset;
      loadAset();
    </script>
  </body>
</html>
