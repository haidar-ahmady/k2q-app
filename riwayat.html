<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Riwayat Pengajuan Perbaikan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
  <div class="container mt-5">
    <a href="admin.html" class="btn btn-secondary mb-3">‚Üê Kembali</a>
    <h4 id="judulRiwayat">Riwayat Pengajuan</h4>
    <div id="riwayatList" class="mt-3"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      orderBy,
      getDocs,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ambil ID aset dari parameter URL dengan aman
    const params = new URLSearchParams(window.location.search);
    const idBarang = params.get("id");

    const judul = document.getElementById("judulRiwayat");
    const kontainer = document.getElementById("riwayatList");

    async function tampilkanRiwayat() {
      if (!idBarang) {
        kontainer.innerHTML = "<p>ID aset tidak ditemukan di URL.</p>";
        return;
      }

      // Ambil informasi aset dari koleksi aset
      const asetRef = doc(db, "aset", idBarang);
      const asetSnap = await getDoc(asetRef);

      if (asetSnap.exists()) {
        const aset = asetSnap.data();
        judul.innerHTML = `Riwayat Pengajuan - ${aset.nama || "-"} (${idBarang})`;
      } else {
        judul.innerHTML = `Riwayat Pengajuan - ${idBarang}`;
      }

      // Ambil data pengajuan perbaikan berdasarkan id aset
      try {
        const q = query(
          collection(db, "pengajuan_perbaikan"),
          where("id", "==", idBarang),
          orderBy("tanggal", "desc")
        );
        const snapshot = await getDocs(q);

        if (snapshot.empty) {
          kontainer.innerHTML = "<p class='text-muted'>Belum ada pengajuan.</p>";
          return;
        }

        snapshot.forEach((doc) => {
          const data = doc.data();
          const tanggal = data.tanggal?.toDate().toLocaleString("id-ID", {
            day: "2-digit",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          const card = document.createElement("div");
          card.className = "card mb-3";
          card.innerHTML = `
            <div class="card-body">
              <p><strong>Tanggal:</strong> ${tanggal}</p>
              <p><strong>Keluhan:</strong> ${data.uraian}</p>
              <p><strong>Status:</strong> ${data.status}</p>
            </div>
          `;
          kontainer.appendChild(card);
        });
      } catch (err) {
        kontainer.innerHTML = `<p class="text-danger">Gagal mengambil riwayat: ${err.message}</p>`;
      }
    }

    tampilkanRiwayat();
  </script>
</body>
</html>
